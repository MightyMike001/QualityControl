<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QC – Simple (Supabase, Light)</title>
  <style>
    :root{
      --bg-outer:#101726;
      --bg-inner:#1f2937;
      --glass:#ffffffb8;
      --glass-border:#ffffff80;
      --card:#fdfdffbf;
      --card-border:#ffffff70;
      --text:#0f172a;
      --muted:#5b6475;
      --muted-strong:#273045;
      --accent:#d7002c;
      --accent-dark:#6b0014;
      --accent-soft:rgba(215,0,44,.12);
      --ok:#16a34a;
      --nok:#dc2626;
      --rework:#eab308;
      --layout-pad:clamp(16px,4vw,48px);
      --shell-radius:clamp(26px,4vw,42px);
      --shell-pad-inline:clamp(10px,3vw,24px);
      --shell-pad-block:clamp(12px,3.2vw,28px);
      --app-gap:clamp(18px,4vw,32px);
      --app-pad-x:clamp(18px,5vw,36px);
      --app-pad-bottom:clamp(24px,6vw,40px);
      --card-radius:clamp(20px,3.2vw,28px);
      --card-pad:clamp(20px,3.2vw,28px);
      --card-gap:clamp(18px,3.4vw,28px);
      --hero-pad:clamp(24px,5vw,40px);
      --hero-gap:clamp(16px,3vw,24px);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:stretch;
      padding:var(--layout-pad);
      font-family:"SF Pro Display",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      font-size:clamp(14px,1.6vw,16px);
      line-height:1.55;
      color:var(--text);
      background:radial-gradient(circle at 20% 20%,rgba(215,0,44,.32),transparent 45%),radial-gradient(circle at 80% 0%,rgba(255,255,255,.22),transparent 40%),linear-gradient(160deg,var(--bg-outer),var(--bg-inner));
    }
    .stage{
      width:100%;
      max-width:1100px;
      margin:0 auto;
    }
    .phone-shell{
      position:relative;
      width:100%;
      border-radius:var(--shell-radius);
      padding:var(--shell-pad-block) var(--shell-pad-inline) calc(var(--shell-pad-block) * 1.6);
      background:rgba(255,255,255,.08);
      box-shadow:0 22px 55px -30px rgba(0,0,0,.65),0 12px 35px -20px rgba(215,0,44,.35);
      border:1px solid rgba(255,255,255,.2);
      backdrop-filter:blur(26px);
    }
    .app{
      padding:0 var(--app-pad-x) var(--app-pad-bottom);
      display:flex;
      flex-direction:column;
      gap:var(--app-gap);
    }
    .hero{
      position:relative;
      border-radius:var(--card-radius);
      padding:var(--hero-pad);
      overflow:hidden;
      background:linear-gradient(140deg,var(--accent),var(--accent-dark));
      color:#fff;
      box-shadow:0 24px 40px -32px rgba(215,0,44,.9);
      display:flex;
      flex-direction:column;
      flex-wrap:wrap;
      gap:var(--hero-gap);
      align-items:flex-start;
      text-align:left;
    }
    @media(min-width:768px){.hero{flex-direction:row;align-items:flex-end;}}
    .hero::after{
      content:"";
      position:absolute;
      inset:-40% -20% auto;
      height:120%;
      background:radial-gradient(circle at 20% 20%,rgba(255,255,255,.28),transparent 55%);
      opacity:.8;
      pointer-events:none;
    }
    .hero>*{position:relative;z-index:1;}
    .title{
      margin:12px 0 8px;
      font-size:clamp(1.8rem,4.2vw,2.5rem);
      font-weight:700;
      letter-spacing:-.01em;
      color:#fff;
    }
    .mini{color:rgba(255,255,255,.78);font-size:clamp(.88rem,2.2vw,1rem);max-width:560px;}
    .tabbar{display:flex;flex-direction:column;align-items:stretch;gap:clamp(12px,3vw,18px);flex-wrap:wrap;}
    @media(min-width:680px){.tabbar{flex-direction:row;align-items:center;justify-content:space-between;}}
    .tabs{
      display:flex;
      gap:8px;
      padding:6px;
      border-radius:22px;
      background:rgba(255,255,255,.7);
      border:1px solid rgba(255,255,255,.5);
      box-shadow:0 12px 24px -18px rgba(15,23,42,.45);
      backdrop-filter:blur(18px);
      width:100%;
    }
    .tab{
      border:none;
      background:transparent;
      padding:clamp(10px,2.4vw,14px) clamp(12px,4vw,22px);
      border-radius:18px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.01em;
      color:var(--muted);
      transition:background .25s ease,color .25s ease,transform .25s ease;
      flex:1;
      min-width:0;
      text-align:center;
    }
    @media(min-width:680px){.tabs{width:auto;}.tab{flex:0 0 auto;}}
    .tab:hover{color:var(--muted-strong);}
    .tab.active{
      background:#fff;
      color:var(--accent);
      box-shadow:0 16px 26px -20px rgba(215,0,44,.8);
      transform:translateY(-1px);
    }
    section.card{
      background:var(--card);
      border:1px solid var(--card-border);
      border-radius:var(--card-radius);
      padding:var(--card-pad);
      box-shadow:0 26px 48px -32px rgba(15,23,42,.38);
      backdrop-filter:blur(18px);
      display:grid;
      gap:var(--card-gap);
    }
    .card{background:rgba(255,255,255,.82);border:1px solid rgba(255,255,255,.7);border-radius:22px;padding:20px;box-shadow:0 16px 32px -26px rgba(15,23,42,.28);backdrop-filter:blur(16px);}
    .card h3{font-weight:600;color:var(--muted-strong);}
    label{display:block;font-size:.78rem;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
    input,select,textarea{
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid transparent;
      background:rgba(255,255,255,.9);
      box-shadow:inset 0 0 0 1px rgba(15,23,42,.06);
      color:var(--text);
      font:inherit;
      transition:box-shadow .25s ease,transform .25s ease;
    }
    input:focus-visible,select:focus-visible,textarea:focus-visible{
      outline:none;
      box-shadow:0 0 0 4px var(--accent-soft),inset 0 0 0 1px rgba(215,0,44,.45);
      transform:translateY(-1px);
    }
    textarea{min-height:100px;resize:vertical;}
    .row{display:flex;gap:clamp(12px,3vw,20px);flex-wrap:wrap}
    .row>.col{flex:1 1 240px;min-width:220px}
    .btn{
      appearance:none;
      border:none;
      padding:12px 18px;
      border-radius:18px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.01em;
      background:rgba(255,255,255,.82);
      color:var(--muted-strong);
      box-shadow:0 18px 32px -24px rgba(15,23,42,.4);
      transition:transform .2s ease,box-shadow .2s ease,background .2s ease;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 18px 36px -20px rgba(15,23,42,.45);}
    .btn:active{transform:translateY(0);box-shadow:0 12px 22px -16px rgba(15,23,42,.4);}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none;}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:#fff;box-shadow:0 26px 40px -28px rgba(215,0,44,.75);}
    .btn.ok{background:linear-gradient(135deg,var(--ok),#34d399);color:#fff;box-shadow:0 26px 40px -28px rgba(22,163,74,.65);}
    .btn.warn{background:linear-gradient(135deg,var(--nok),#f87171);color:#fff;box-shadow:0 26px 40px -28px rgba(220,38,38,.6);}
    .btn.ghost{background:rgba(255,255,255,.24);color:#fff;border:1px solid rgba(255,255,255,.45);box-shadow:none;}
    .btn.link{border:none;background:none;color:var(--accent);padding:0;font-weight:600;box-shadow:none;}
    .btn.link:hover{text-decoration:underline;background:none;transform:none;}
    .tab:focus-visible,.btn:focus-visible{outline:3px solid var(--accent-soft);outline-offset:2px;}
    @media (prefers-reduced-motion: reduce){.tab,.btn,input,select,textarea{transition:none}}
    .grid{display:grid;gap:clamp(16px,3vw,24px)}
    .metrics-grid{grid-template-columns:repeat(auto-fit,minmax(180px,1fr));}
    .metric-card{display:flex;flex-direction:column;gap:8px;padding:18px;background:rgba(255,255,255,.86);border:1px solid rgba(255,255,255,.7);border-radius:20px;box-shadow:0 16px 30px -26px rgba(15,23,42,.28);}
    .metric-label{font-size:.78rem;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);}
    .metric-value{font-size:1.9rem;font-weight:700;color:var(--muted-strong);}
    .metric-sub{font-size:.85rem;color:var(--muted);}
    .chart-grid{grid-template-columns:repeat(auto-fit,minmax(260px,1fr));}
    .chart-card{display:flex;flex-direction:column;gap:14px;}
    .chart-canvas{position:relative;width:100%;height:clamp(220px,32vh,360px);}
    .chart-canvas canvas{position:absolute;inset:0;width:100%!important;height:100%!important;max-width:100%;}
    .chart-note{color:var(--muted);font-size:.85rem;}
    .thumbs{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .thumbs img{width:clamp(110px,28vw,140px);height:clamp(88px,24vw,110px);object-fit:cover;border-radius:18px;border:1px solid rgba(255,255,255,.7);background:#f3f4f6;box-shadow:0 18px 32px -26px rgba(15,23,42,.4);cursor:pointer;transition:transform .2s ease}
    .thumbs img:hover{transform:translateY(-2px);}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:min(520px,100%);background:rgba(255,255,255,.78);border:1px solid rgba(255,255,255,.6);border-radius:18px;overflow:hidden;box-shadow:0 12px 24px -22px rgba(15,23,42,.32);}
    th,td{padding:12px 14px;vertical-align:top;border-top:1px solid rgba(15,23,42,.06);font-size:clamp(.82rem,1.8vw,.92rem);}
    th{background:rgba(15,23,42,.04);color:var(--muted-strong);text-align:left;font-weight:600;letter-spacing:.04em;text-transform:uppercase;font-size:.75rem;}
    table tr:first-child th{border-top:none}
    table tr:first-child td{border-top:none}
    .table-scroll{overflow:auto;padding-bottom:4px;-webkit-overflow-scrolling:touch;}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:.78rem;font-weight:600;border:1px solid rgba(15,23,42,.08);background:rgba(15,23,42,.02);}
    .b-ok{color:var(--ok);background:rgba(22,163,74,.12);}
    .b-nok{color:var(--nok);background:rgba(220,38,38,.12);}
    .b-rw{color:var(--rework);background:rgba(234,179,8,.14);}
    video#cam{width:100%;max-height:clamp(220px,40vh,360px);border-radius:24px;border:1px solid rgba(255,255,255,.6);display:none;background:#000;box-shadow:0 20px 36px -28px rgba(15,23,42,.55);}
    canvas#snap{display:none}
    .thumb{position:relative}
    .thumb button.del{position:absolute;top:8px;right:8px;border:1px solid rgba(255,255,255,.7);background:rgba(0,0,0,.55);color:#fff;border-radius:999px;padding:4px 8px;cursor:pointer;box-shadow:0 12px 22px -16px rgba(0,0,0,.55);}
    .viewer{position:fixed;inset:0;background:rgba(12,18,28,.82);display:flex;align-items:center;justify-content:center;padding:clamp(16px,4vw,36px);z-index:9999;backdrop-filter:blur(10px)}
    .viewer[hidden]{display:none}
    .viewer-inner{position:relative;background:rgba(15,23,42,.9);border-radius:28px;max-width:90vw;max-height:90vh;padding:18px;display:flex;flex-direction:column;gap:18px;box-shadow:0 30px 60px -40px rgba(0,0,0,.8)}
    .viewer-inner img{max-width:80vw;max-height:70vh;object-fit:contain;border-radius:18px;background:#111}
    .viewer-controls{display:flex;align-items:center;justify-content:center;gap:18px;color:#fff;font-weight:600}
    .viewer-close{position:absolute;top:14px;right:14px;background:rgba(255,255,255,.12);color:#fff;border:none;border-radius:999px;width:40px;height:40px;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 18px 32px -24px rgba(0,0,0,.75)}
    .viewer-close:focus-visible{outline:3px solid var(--accent-soft);outline-offset:2px}
    .viewer-nav{background:rgba(255,255,255,.16);color:#fff;border:1px solid rgba(255,255,255,.3);padding:10px 18px;border-radius:999px;cursor:pointer;font-weight:600;}
    .viewer-nav[disabled]{opacity:.5;cursor:default}
    @media(max-width:900px){table{min-width:0;font-size:.88rem;}th,td{white-space:nowrap;}}
    @media(max-width:600px){
      .row>.col{min-width:100%;}
      table{display:block;overflow:auto;}
    }
  </style>
</head>
<body>
  <div class="stage">
    <div class="phone-shell">
      <div class="app">
        <header class="hero">
          <div>
            <h1 class="title">Quality Control</h1>
          </div>
        </header>

        <div class="tabbar">
          <div class="tabs" role="tablist" aria-label="QC tabs">
            <button id="form-tab" class="tab active" data-tab="form" role="tab" aria-selected="true" aria-controls="form">Formulier</button>
            <button id="dashboard-tab" class="tab" data-tab="dashboard" role="tab" aria-selected="false" aria-controls="dashboard">Dashboard</button>
            <button id="analysis-tab" class="tab" data-tab="analysis" role="tab" aria-selected="false" aria-controls="analysis">Analyses</button>
          </div>
        </div>

    <!-- FORM -->
    <section id="form" class="card grid" role="tabpanel" aria-labelledby="form-tab">
      <div class="row">
        <div class="col">
          <label for="serial">Serienummer</label>
          <input id="serial" placeholder="Bijv. E16-01 / SN12345" />
        </div>
        <div class="col">
          <label for="initials">Initialen werknemer</label>
          <input id="initials" placeholder="Bijv. MG" />
        </div>
        <div class="col">
          <label for="date">Datum</label>
          <input id="date" type="date" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label for="status">Status</label>
          <select id="status">
            <option value="GOEDGEKEURD">Goedgekeurd</option>
            <option value="AFGEKEURD">Afgekeurd</option>
            <option value="GOED NA AFKEUR">Goed na afkeur</option>
          </select>
        </div>
        <div class="col">
          <label for="report">Melding</label>
          <input id="report" placeholder="Bijv. M-2024-001" />
        </div>
      </div>

      <div>
        <label for="desc">Beschrijving</label>
        <textarea id="desc" placeholder="Korte toelichting"></textarea>
      </div>

      <div>
        <label>Foto's</label>
        <div class="row" style="align-items:center">
          <div class="col" style="flex:0 0 auto; display:flex; gap:8px; flex-wrap:wrap">
            <button id="openCam" class="btn" type="button">Camera openen</button>
            <button id="takeShot" class="btn ok" type="button" disabled>Foto nemen</button>
            <button id="flipCam" class="btn" type="button" disabled>Wissel camera</button>
            <button id="closeCam" class="btn" type="button" disabled>Sluit camera</button>
          </div>
        </div>
        <video id="cam" autoplay playsinline muted></video>
        <canvas id="snap"></canvas>
        <div id="thumbs" class="thumbs" data-testid="thumbs"></div>
      </div>

      <div class="row" style="align-items:center">
        <button class="btn primary" id="save" type="button">Opslaan</button>
        <button class="btn" id="resetForm" type="button">Formulier leeg</button>
        <div id="saveNote" class="mini" aria-live="polite"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 6px">Laatste registraties (Supabase)</h3>
        <div class="table-scroll">
          <table id="recent">
          <thead>
            <tr><th>Datum</th><th>Initialen</th><th>Serienr</th><th>Status</th><th>Foto's</th></tr>
          </thead>
          <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="card grid" style="display:none" role="tabpanel" aria-labelledby="dashboard-tab">
      <div class="row">
        <div class="col"><label for="filterFrom">Vanaf</label><input id="filterFrom" type="date" /></div>
        <div class="col"><label for="filterTo">Tot en met</label><input id="filterTo" type="date" /></div>
        <div class="col"><label for="filterInitials">Initialen (optioneel)</label><input id="filterInitials" placeholder="Bijv. MG" /></div>
        <div class="col"><label for="filterSerial">Serienummer (optioneel)</label><input id="filterSerial" placeholder="Bijv. 12345" /></div>
        <div class="col"><label for="filterReport">Meldingsnummer (optioneel)</label><input id="filterReport" placeholder="Bijv. M-001" /></div>
        <div class="col" style="align-self:end"><button id="applyFilters" class="btn" type="button">Toepassen</button></div>
      </div>
      <div class="grid">
        <div class="card">
          <h3 style="margin:0 0 6px">Totaal per werknemer (Supabase)</h3>
          <div class="table-scroll">
            <table id="byWorker"><thead><tr><th>Initialen</th><th>Totaal</th><th>OK</th><th>NOK</th><th>Rework</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card">
          <h3 style="margin:0 0 6px">Details (Supabase)</h3>
          <div class="table-scroll">
            <table id="detail"><thead><tr><th>Datum</th><th>Initialen</th><th>Serienr</th><th>Status</th><th>Melding</th><th>Beschrijving</th><th>Foto's</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </section>

    <!-- ANALYSIS -->
    <section id="analysis" class="card grid" style="display:none" role="tabpanel" aria-labelledby="analysis-tab">
      <div class="grid metrics-grid" id="analysisSummary">
        <div class="metric-card">
          <span class="metric-label">Totaal (90 dagen)</span>
          <strong class="metric-value" id="metricTotal">–</strong>
          <span class="metric-sub" id="metricSpan">–</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">OK-percentage</span>
          <strong class="metric-value" id="metricOkRate">–</strong>
          <span class="metric-sub">Goedgekeurde controles</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Unieke werknemers</span>
          <strong class="metric-value" id="metricWorkers">–</strong>
          <span class="metric-sub" id="metricWorkersSub">–</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Gemiddeld per dag</span>
          <strong class="metric-value" id="metricPerDay">–</strong>
          <span class="metric-sub">Laatste 90 dagen</span>
        </div>
      </div>

      <div class="grid chart-grid">
        <div class="card chart-card">
          <h3 style="margin:0">Verdeling status</h3>
          <div class="chart-canvas">
            <canvas id="analysisStatusChart" height="220" aria-label="Status verdeling" role="img"></canvas>
          </div>
          <p class="chart-note" id="analysisStatusNote">—</p>
        </div>
        <div class="card chart-card">
          <h3 style="margin:0">Trendlijn per maand</h3>
          <div class="chart-canvas">
            <canvas id="analysisTrendChart" height="220" aria-label="Trendlijn per maand" role="img"></canvas>
          </div>
          <p class="chart-note" id="analysisTrendNote">—</p>
        </div>
        <div class="card chart-card">
          <h3 style="margin:0">Top werknemers</h3>
          <div class="chart-canvas">
            <canvas id="analysisWorkerChart" height="220" aria-label="Top werknemers" role="img"></canvas>
          </div>
          <p class="chart-note" id="analysisWorkerNote">—</p>
        </div>
      </div>
    </section>
      </div>
    </div>
  </div>

  <div id="photoViewer" class="viewer" hidden aria-hidden="true">
    <div class="viewer-inner" role="dialog" aria-modal="true" aria-label="Foto viewer">
      <button type="button" class="viewer-close" id="viewerClose" aria-label="Sluiten">×</button>
      <img id="viewerImage" alt="QC-foto" />
      <div class="viewer-controls">
        <button type="button" class="viewer-nav" id="viewerPrev">Vorige</button>
        <span id="viewerCounter"></span>
        <button type="button" class="viewer-nav" id="viewerNext">Volgende</button>
      </div>
    </div>
  </div>

  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ===== Config =====
    const SUPABASE_URL = 'https://kyzpxfkzugxlqfxhadhr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt5enB4Zmt6dWd4bHFmeGhhZGhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2Mzk2MDYsImV4cCI6MjA3NzIxNTYwNn0.Qw7JpA_v8vbC4R2qLX1xkzp2qo1LlAc0sz-s5NdsU5Y';
    const STORAGE_BUCKET_CANDIDATES = ['qc-photos', 'qc_photos'];
    let resolvedBucketName = null;
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const ANALYSIS_WINDOW_DAYS = 90;
    const ANALYSIS_LOCALE = 'nl-NL';
    let analysisLoading = false;
    let statusChart = null;
    let trendChart = null;
    let workerChart = null;
    const globalCrypto = globalThis.crypto || globalThis.msCrypto || null;
    function safeUUID(){
      if(globalCrypto?.randomUUID) return globalCrypto.randomUUID();
      if(globalCrypto?.getRandomValues){
        const bytes=new Uint8Array(16);
        globalCrypto.getRandomValues(bytes);
        bytes[6]=(bytes[6]&0x0f)|0x40;
        bytes[8]=(bytes[8]&0x3f)|0x80;
        const hex=Array.from(bytes,b=>b.toString(16).padStart(2,'0'));
        return `${hex.slice(0,4).join('')}-${hex.slice(4,6).join('')}-${hex.slice(6,8).join('')}-${hex.slice(8,10).join('')}-${hex.slice(10).join('')}`;
      }
      return `id-${Date.now().toString(16)}-${Math.random().toString(16).slice(2,10)}`;
    }

    // ===== Helpers =====
    const $ = s => document.querySelector(s); const $$ = s => Array.from(document.querySelectorAll(s));
    const today = () => new Date().toISOString().slice(0,10);
    const numberFormat = new Intl.NumberFormat(ANALYSIS_LOCALE);
    const percentFormat = new Intl.NumberFormat(ANALYSIS_LOCALE, { minimumFractionDigits:1, maximumFractionDigits:1 });
    const decimalFormat = new Intl.NumberFormat(ANALYSIS_LOCALE, { minimumFractionDigits:1, maximumFractionDigits:1 });
    function dataUrlToBlob(dataUrl){ const [meta,b64]=dataUrl.split(','); const mime=(meta.match(/:(.*?);/)||[])[1]||'image/jpeg'; const bin=atob(b64); const u8=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i); return new Blob([u8],{type:mime}); }
    function escapeLikePattern(value){ return value.replace(/[\\%_]/g,c=>`\\${c}`); }
    function isoToDate(iso){ if(!iso) return null; const [y,m,d]=iso.split('-').map(Number); if(!y||!m||!d) return null; return new Date(y, m-1, d); }

    // ===== Photo viewer =====
    let viewerPhotos=[], viewerIndex=0;
    function updateViewer(){
      if(!viewerPhotos.length){ closeViewer(); return; }
      const img=$('#viewerImage');
      const counter=$('#viewerCounter');
      const prev=$('#viewerPrev');
      const next=$('#viewerNext');
      img.src=viewerPhotos[viewerIndex];
      counter.textContent=`${viewerIndex+1} / ${viewerPhotos.length}`;
      const disableNav=viewerPhotos.length<=1;
      prev.disabled=disableNav;
      next.disabled=disableNav;
    }
    function openViewer(photos,startIndex=0){
      if(!photos?.length) return;
      viewerPhotos=photos.slice();
      viewerIndex=Math.min(Math.max(startIndex,0), viewerPhotos.length-1);
      $('#photoViewer').hidden=false;
      $('#photoViewer').setAttribute('aria-hidden','false');
      document.body.style.overflow='hidden';
      updateViewer();
    }
    function closeViewer(){
      $('#photoViewer').hidden=true;
      $('#photoViewer').setAttribute('aria-hidden','true');
      viewerPhotos=[];
      viewerIndex=0;
      document.body.style.overflow='';
    }


    // ===== Camera =====
    let camStream=null, camFacing='environment', camShots=[];
    async function openCamera(){
      try{ camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:camFacing}});
           const v=$('#cam'); v.srcObject=camStream; v.style.display='block';
           $('#takeShot').disabled=$('#flipCam').disabled=$('#closeCam').disabled=false; }
      catch{ alert('Camera niet beschikbaar/toestemming geweigerd. Gebruik bestandsupload.'); }
    }
    function stopCamera(){ const v=$('#cam'); if(camStream){camStream.getTracks().forEach(t=>t.stop()); camStream=null;} v.srcObject=null; v.style.display='none'; $('#takeShot').disabled=$('#flipCam').disabled=$('#closeCam').disabled=true; }
    function capturePhoto(){ const v=$('#cam'); if(!v.videoWidth) return; const c=$('#snap'); c.width=v.videoWidth; c.height=v.videoHeight; const ctx=c.getContext('2d'); ctx.drawImage(v,0,0,c.width,c.height); const ts=new Date().toISOString().replace('T',' ').slice(0,19); ctx.fillStyle='rgba(0,0,0,.5)'; ctx.fillRect(10,c.height-34,200,24); ctx.fillStyle='#fff'; ctx.font='16px system-ui'; ctx.fillText(ts,16,c.height-18); const d=c.toDataURL('image/jpeg',0.85); camShots.unshift(d); renderThumb(d); }
    function renderThumb(data){
      const wrap=document.createElement('div');
      wrap.className='thumb';
      const img=new Image();
      img.src=data;
      img.alt='QC-foto';
      img.loading='lazy';
      img.addEventListener('click',()=>{
        const all=$$('#thumbs img').map(node=>node.src);
        const idx=all.indexOf(img.src);
        openViewer(all, idx>=0?idx:0);
      });
      const del=document.createElement('button');
      del.className='del';
      del.textContent='✕';
      del.addEventListener('click',()=>{wrap.remove(); camShots=camShots.filter(d=>d!==data);});
      wrap.appendChild(img);
      wrap.appendChild(del);
      $('#thumbs').prepend(wrap);
    }

    // ===== Tabs =====
    const tabIds=['form','dashboard','analysis'];
    function activateTab(tab){
      tabIds.forEach(id=>{
        const panel=document.getElementById(id);
        if(panel){ panel.style.display=id===tab?'block':'none'; }
      });
      if(tab!=='form') stopCamera();
      if(tab==='dashboard') renderDashboardSupabase();
      if(tab==='analysis') renderAnalysisSupabase();
    }
    $$('.tab').forEach(btn=>btn.addEventListener('click',()=>{
      $$('.tab').forEach(b=>{b.classList.remove('active'); b.setAttribute('aria-selected','false');});
      btn.classList.add('active');
      btn.setAttribute('aria-selected','true');
      const tab=btn.dataset.tab;
      activateTab(tab);
    }));

    // ===== Init =====
    $('#date').value=today();

    // ===== Save (Supabase) =====
    function bucketNotFound(err){ return typeof err?.message==='string' && err.message.toLowerCase().includes('bucket') && err.message.toLowerCase().includes('not found'); }
    function objectNotFound(err){ return typeof err?.message==='string' && err.message.toLowerCase().includes('object') && err.message.toLowerCase().includes('not found'); }
    function bucketCandidates(){ if(resolvedBucketName){ return [resolvedBucketName, ...STORAGE_BUCKET_CANDIDATES.filter(n=>n!==resolvedBucketName)]; } return STORAGE_BUCKET_CANDIDATES.slice(); }
    async function uploadPhotosToBucket(bucketName, folder, files, shots){
      const bucket=supa.storage.from(bucketName);
      const uploaded=[];
      try{
        for(const f of files){
          const ext=(f.type||'image/jpeg').split('/')[1]||'jpg';
          const path=`${folder}/${safeUUID()}.${ext}`;
          const {error}=await bucket.upload(path,f,{upsert:false,contentType:f.type||'image/jpeg'});
          if(error) throw error;
          uploaded.push(path);
        }
        for(const d of shots){
          const blob=dataUrlToBlob(d);
          const path=`${folder}/${safeUUID()}.jpg`;
          const {error}=await bucket.upload(path,blob,{upsert:false,contentType:'image/jpeg'});
          if(error) throw error;
          uploaded.push(path);
        }
        return uploaded;
      }catch(err){
        if(uploaded.length && !bucketNotFound(err)){
          try{ await bucket.remove(uploaded); }catch(_e){ /* noop cleanup failure */ }
        }
        throw err;
      }
    }
    async function uploadPhotosWithFallback(folder, files, shots){
      if(!files.length && !shots.length) return [];
      let lastBucketError=null;
      for(const name of bucketCandidates()){
        try{
          const paths=await uploadPhotosToBucket(name, folder, files, shots);
          resolvedBucketName=name;
          return paths;
        }catch(err){
          if(bucketNotFound(err)){ lastBucketError=err; continue; }
          throw err;
        }
      }
      throw new Error('Supabase opslagbucket niet gevonden (qc-photos/qc_photos).');
    }
    async function createSignedUrlWithFallback(storagePath){
      let lastErr=null;
      for(const name of bucketCandidates()){
        const bucket=supa.storage.from(name);
        const {data, error}=await bucket.createSignedUrl(storagePath,300);
        if(!error && data?.signedUrl){ resolvedBucketName=name; return data.signedUrl; }
        if(error && (bucketNotFound(error)||objectNotFound(error))){ lastErr=error; continue; }
        if(error) throw error;
      }
      if(lastErr) throw lastErr;
      return null;
    }

    $('#save').addEventListener('click', async ()=>{
      const serial=$('#serial').value.trim(); const initials=$('#initials').value.trim().toUpperCase(); const date=$('#date').value||today(); const status=$('#status').value; const report=$('#report').value.trim(); const desc=$('#desc').value.trim(); if(!serial||!initials){ alert('Vul serienummer en initialen in.'); return; }
      try{
        // upload naar Storage
        const folder=`records/${safeUUID()}`;
        const photoPaths=await uploadPhotosWithFallback(folder, [], camShots);
        // atomic insert
        const rpcPhotoPaths = photoPaths.length ? photoPaths : [];
        const { data: insertedId, error } = await supa.rpc('qc_insert_record_with_photos', { p_serial:serial, p_worker_initials:initials, p_status:status, p_report:report||null, p_description:desc||null, p_qc_date:date, p_photo_paths:rpcPhotoPaths });
        if(error) throw error;
        $('#saveNote').textContent=`Opgeslagen in Supabase (id: ${insertedId})`;
        await renderRecent();
        resetForm(false);
        stopCamera();
      }catch(e){
        console.error('Supabase save failed', e);
        $('#saveNote').textContent=`Opslaan mislukt: ${e.message||e}`;
      }
    });

    function resetForm(clearDate=true){ $('#serial').value=''; $('#initials').value=''; $('#status').value='GOEDGEKEURD'; $('#report').value=''; $('#desc').value=''; $('#thumbs').innerHTML=''; camShots=[]; if(clearDate) $('#date').value=today(); setTimeout(()=>$('#saveNote').textContent='',2000); }
    $('#resetForm').addEventListener('click',()=>resetForm());

    async function renderRecent(){
      const tbody=$('#recent tbody');
      if(!tbody) return;
      tbody.innerHTML='<tr><td colspan="5">Laden...</td></tr>';
      try{
        const { data, error } = await supa
          .from('qc_record')
          .select('id,qc_date,worker_initials,serial,status,qc_photo(id)')
          .order('qc_date',{ascending:false})
          .order('created_at',{ascending:false})
          .limit(10);
        if(error) throw error;
        const items=data||[];
        if(!items.length){
          tbody.innerHTML='<tr><td colspan="5">Geen registraties</td></tr>';
          return;
        }
        tbody.innerHTML='';
        for(const r of items){
          const tr=document.createElement('tr');
          const badge=r.status==='GOEDGEKEURD'?'<span class="badge b-ok">OK</span>':(r.status==='AFGEKEURD'?'<span class="badge b-nok">NOK</span>':'<span class="badge b-rw">GOED\u00A0NA\u00A0AFKEUR</span>');
          const photoCnt=Array.isArray(r.qc_photo)?r.qc_photo.length:0;
          const dateTd=document.createElement('td'); dateTd.textContent=r.qc_date;
          const initTd=document.createElement('td'); initTd.textContent=r.worker_initials;
          const serialTd=document.createElement('td'); serialTd.textContent=r.serial;
          const statusTd=document.createElement('td'); statusTd.innerHTML=badge;
          const photosTd=document.createElement('td');
          if(photoCnt){
            const btn=document.createElement('button');
            btn.type='button';
            btn.className='btn link';
            btn.textContent=`Bekijk (${photoCnt})`;
            btn.addEventListener('click',()=>viewSupabasePhotos(r.id, btn));
            photosTd.appendChild(btn);
          }else{
            photosTd.textContent='–';
          }
          tr.append(dateTd, initTd, serialTd, statusTd, photosTd);
          tbody.appendChild(tr);
        }
      }catch(e){
        console.error('renderRecent', e);
        tbody.innerHTML=`<tr><td colspan="5">Fout bij laden: ${e.message||e}</td></tr>`;
      }
    }
    renderRecent();


    // ===== Dashboard (Supabase) =====
    async function renderDashboardSupabase(){
      const from=$('#filterFrom').value||null; const to=$('#filterTo').value||null; const who=$('#filterInitials').value.trim().toUpperCase(); const serial=$('#filterSerial').value.trim(); const report=$('#filterReport').value.trim();
      const byWorkerTbody=$('#byWorker tbody'); const detailTbody=$('#detail tbody');
      byWorkerTbody.innerHTML='<tr><td colspan="5">Laden...</td></tr>';
      detailTbody.innerHTML='<tr><td colspan="7">Laden...</td></tr>';
      let q=supa.from('qc_record').select('id,qc_date,worker_initials,serial,status,report,description').order('qc_date',{ascending:false});
      if(from) q=q.gte('qc_date',from); if(to) q=q.lte('qc_date',to); if(who) q=q.eq('worker_initials',who); if(serial) q=q.ilike('serial',`%${escapeLikePattern(serial)}%`); if(report) q=q.ilike('report',`%${escapeLikePattern(report)}%`);
      const { data: details, error: detErr } = await q;
      if(detErr){
        byWorkerTbody.innerHTML=`<tr><td colspan="5">Fout: ${detErr.message}</td></tr>`;
        detailTbody.innerHTML=`<tr><td colspan="7">Fout: ${detErr.message}</td></tr>`;
        return;
      }
      const items=details||[];
      if(!items.length){
        byWorkerTbody.innerHTML='<tr><td colspan="5">Geen data</td></tr>';
        detailTbody.innerHTML='<tr><td colspan="7">Geen details</td></tr>';
        return;
      }
      const workerStats=new Map();
      for(const row of items){
        const worker=(row.worker_initials||'Onbekend').toUpperCase();
        if(!workerStats.has(worker)) workerStats.set(worker,{worker_initials:worker,total:0,ok:0,nok:0,rework:0});
        const entry=workerStats.get(worker);
        entry.total+=1;
        if(row.status==='GOEDGEKEURD') entry.ok+=1;
        else if(row.status==='AFGEKEURD') entry.nok+=1;
        else if(row.status==='GOED NA AFKEUR') entry.rework+=1;
      }
      const workerRows=Array.from(workerStats.values()).sort((a,b)=>a.worker_initials.localeCompare(b.worker_initials)).map(r=>`<tr><td><strong>${r.worker_initials}</strong></td><td>${r.total}</td><td>${r.ok}</td><td>${r.nok}</td><td>${r.rework}</td></tr>`).join('');
      byWorkerTbody.innerHTML=workerRows||'<tr><td colspan="5">Geen data</td></tr>';
      detailTbody.innerHTML='';
      for(const r of items){
        const tr=document.createElement('tr');
        const badge=r.status==='GOEDGEKEURD'?'<span class="badge b-ok">OK</span>':(r.status==='AFGEKEURD'?'<span class="badge b-nok">NOK</span>':'<span class="badge b-rw">GOED\u00A0NA\u00A0AFKEUR</span>');
        const dateTd=document.createElement('td'); dateTd.textContent=r.qc_date;
        const initTd=document.createElement('td'); initTd.textContent=r.worker_initials;
        const serialTd=document.createElement('td'); serialTd.textContent=r.serial;
        const statusTd=document.createElement('td'); statusTd.innerHTML=badge;
        const reportTd=document.createElement('td'); reportTd.textContent=r.report||'';
        const descTd=document.createElement('td'); descTd.textContent=r.description||'';
        const photosTd=document.createElement('td');
        const btn=document.createElement('button');
        btn.type='button';
        btn.className='btn link';
        btn.textContent='Bekijk';
        btn.addEventListener('click',()=>viewSupabasePhotos(r.id, btn));
        photosTd.appendChild(btn);
        tr.append(dateTd, initTd, serialTd, statusTd, reportTd, descTd, photosTd);
        detailTbody.appendChild(tr);
      }
    }
    $('#applyFilters').addEventListener('click', renderDashboardSupabase);

    async function renderAnalysisSupabase(){
      if(analysisLoading) return;
      analysisLoading=true;
      const statusNote=$('#analysisStatusNote');
      const trendNote=$('#analysisTrendNote');
      const workerNote=$('#analysisWorkerNote');
      statusNote.textContent='Laden...';
      trendNote.textContent='Laden...';
      workerNote.textContent='Laden...';
      const cutoffDate=new Date();
      cutoffDate.setDate(cutoffDate.getDate()-(ANALYSIS_WINDOW_DAYS-1));
      const cutoffStr=cutoffDate.toISOString().slice(0,10);
      try{
        const { data, error } = await supa
          .from('qc_record')
          .select('qc_date,worker_initials,status')
          .gte('qc_date', cutoffStr)
          .order('qc_date',{ascending:true});
        if(error) throw error;
        const records=(data||[]).filter(r=>r?.qc_date);
        const metricSpan=$('#metricSpan');
        const metricOkRate=$('#metricOkRate');
        const metricTotal=$('#metricTotal');
        const metricWorkers=$('#metricWorkers');
        const metricWorkersSub=$('#metricWorkersSub');
        const metricPerDay=$('#metricPerDay');
        if(!records.length){
          metricTotal.textContent='0';
          metricSpan.textContent=`Geen registraties sinds ${cutoffStr}`;
          metricOkRate.textContent='0%';
          metricWorkers.textContent='0';
          metricWorkersSub.textContent='Geen werknemers gevonden';
          metricPerDay.textContent=decimalFormat.format(0);
          statusNote.textContent='Geen data voor de geselecteerde periode.';
          trendNote.textContent='Geen data voor de geselecteerde periode.';
          workerNote.textContent='Geen data voor de geselecteerde periode.';
          statusChart?.destroy(); trendChart?.destroy(); workerChart?.destroy();
          statusChart=trendChart=workerChart=null;
          analysisLoading=false;
          return;
        }

        const firstDate=isoToDate(records[0].qc_date);
        const lastDate=isoToDate(records[records.length-1].qc_date);
        metricTotal.textContent=numberFormat.format(records.length);
        if(firstDate && lastDate){
          metricSpan.textContent=`${firstDate.toLocaleDateString(ANALYSIS_LOCALE)} – ${lastDate.toLocaleDateString(ANALYSIS_LOCALE)}`;
        }else{
          metricSpan.textContent='—';
        }

        const statusCounts={GOEDGEKEURD:0,AFGEKEURD:0,'GOED NA AFKEUR':0};
        const workerCounts=new Map();
        for(const row of records){
          const status=row.status||'OVERIG';
          if(statusCounts[status]===undefined) statusCounts[status]=0;
          statusCounts[status]+=1;
          const worker=(row.worker_initials||'Onbekend').toUpperCase();
          workerCounts.set(worker,(workerCounts.get(worker)||0)+1);
        }

        const okCount=statusCounts.GOEDGEKEURD||0;
        const total=records.length;
        const okRate=total?percentFormat.format((okCount/total)*100):percentFormat.format(0);
        metricOkRate.textContent=`${okRate}%`;
        metricWorkers.textContent=numberFormat.format(workerCounts.size);
        if(workerCounts.size){
          metricWorkersSub.textContent=workerCounts.size===1?'1 werknemer actief in periode':`${numberFormat.format(workerCounts.size)} werknemers actief in periode`;
        }else{
          metricWorkersSub.textContent='Geen werknemers gevonden';
        }

        let daySpan=0;
        if(firstDate && lastDate){
          const diff=lastDate.getTime()-firstDate.getTime();
          daySpan=Math.max(1,Math.round(diff/86400000)+1);
        }
        const perDay=total&&daySpan?decimalFormat.format(total/daySpan):decimalFormat.format(0);
        metricPerDay.textContent=perDay;

        const statusLabels=['Goedgekeurd','Afgekeurd','Goed na afkeur'];
        const statusValues=[statusCounts.GOEDGEKEURD||0,statusCounts.AFGEKEURD||0,statusCounts['GOED NA AFKEUR']||0];
        const statusCtx=document.getElementById('analysisStatusChart').getContext('2d');
        if(statusChart){
          statusChart.data.labels=statusLabels;
          statusChart.data.datasets[0].data=statusValues;
          statusChart.update();
        }else{
          statusChart=new Chart(statusCtx,{type:'doughnut',data:{labels:statusLabels,datasets:[{data:statusValues,backgroundColor:['rgba(22,163,74,.7)','rgba(220,38,38,.7)','rgba(234,179,8,.75)'],borderColor:['rgba(22,163,74,1)','rgba(220,38,38,1)','rgba(234,179,8,1)'],borderWidth:1}]},options:{plugins:{legend:{position:'bottom'}},maintainAspectRatio:false,cutout:'55%'}});
        }
        statusNote.textContent=`Goedgekeurd: ${numberFormat.format(statusValues[0])} • Afgekeurd: ${numberFormat.format(statusValues[1])} • Goed na afkeur: ${numberFormat.format(statusValues[2])}`;

        const monthCounts=new Map();
        for(const row of records){
          const key=(row.qc_date||'').slice(0,7);
          if(!key) continue;
          monthCounts.set(key,(monthCounts.get(key)||0)+1);
        }
        const monthEntries=Array.from(monthCounts.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
        const trendLabels=monthEntries.map(([key])=>{
          const date=isoToDate(`${key}-01`);
          return date?date.toLocaleDateString(ANALYSIS_LOCALE,{month:'short',year:'numeric'}):key;
        });
        const trendValues=monthEntries.map(([,value])=>value);
        const trendCtx=document.getElementById('analysisTrendChart').getContext('2d');
        if(trendChart){
          trendChart.data.labels=trendLabels;
          trendChart.data.datasets[0].data=trendValues;
          trendChart.update();
        }else{
          trendChart=new Chart(trendCtx,{type:'line',data:{labels:trendLabels,datasets:[{label:'Controles',data:trendValues,borderColor:'rgba(215,0,44,.85)',backgroundColor:'rgba(215,0,44,.2)',tension:.3,fill:false,pointRadius:4}]},options:{plugins:{legend:{display:false}},maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{precision:0}}}}});
        }
        if(trendLabels.length){
          trendNote.textContent=`Periode: ${trendLabels[0]} – ${trendLabels[trendLabels.length-1]}`;
        }else{
          trendNote.textContent='Geen maandgegevens beschikbaar.';
        }

        const workerEntries=Array.from(workerCounts.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5);
        const workerLabels=workerEntries.map(([key])=>key);
        const workerValues=workerEntries.map(([,value])=>value);
        const workerCtx=document.getElementById('analysisWorkerChart').getContext('2d');
        if(workerChart){
          workerChart.data.labels=workerLabels;
          workerChart.data.datasets[0].data=workerValues;
          workerChart.update();
        }else{
          workerChart=new Chart(workerCtx,{type:'bar',data:{labels:workerLabels,datasets:[{label:'Controles',data:workerValues,backgroundColor:'rgba(15,23,42,.7)'}]},options:{indexAxis:'y',plugins:{legend:{display:false}},maintainAspectRatio:false,scales:{x:{beginAtZero:true,ticks:{precision:0}}}}});
        }
        workerNote.textContent=`Top ${workerLabels.length} van ${workerCounts.size} werknemers.`;
      }catch(e){
        console.error('renderAnalysisSupabase', e);
        $('#analysisStatusNote').textContent=`Fout bij laden: ${e.message||e}`;
        $('#analysisTrendNote').textContent='—';
        $('#analysisWorkerNote').textContent='—';
      }finally{
        analysisLoading=false;
      }
    }

    async function viewSupabasePhotos(recordId, triggerEl){
      if(!recordId) return;
      const btn=triggerEl;
      const originalText=btn?.textContent;
      if(btn){ btn.disabled=true; btn.textContent='Laden...'; }
      try{
        const { data, error } = await supa.from('qc_photo').select('storage_path').eq('record_id', recordId);
        if(error) throw error;
        if(!data?.length){ alert('Geen foto\'s gevonden.'); return; }
        const urls=[];
        for(const row of data){
          const storagePath=row?.storage_path;
          if(!storagePath) continue;
          const signedUrl=await createSignedUrlWithFallback(storagePath);
          if(signedUrl) urls.push(signedUrl);
        }
        if(!urls.length){ alert('Geen foto\'s beschikbaar.'); return; }
        openViewer(urls);
      }catch(e){
        console.error('viewSupabasePhotos', e);
        alert(`Foto's openen mislukt: ${e.message||e}`);
      }finally{
        if(btn){ btn.disabled=false; btn.textContent=originalText; }
      }
    }

    // ===== Wire camera buttons =====
    $('#openCam').addEventListener('click', openCamera);
    $('#takeShot').addEventListener('click', capturePhoto);
    $('#flipCam').addEventListener('click', async ()=>{ camFacing=(camFacing==='environment')?'user':'environment'; stopCamera(); await openCamera(); });
    $('#closeCam').addEventListener('click', stopCamera);

    // ===== Photo viewer events =====
    $('#viewerClose').addEventListener('click', closeViewer);
    $('#photoViewer').addEventListener('click', e=>{ if(e.target===e.currentTarget) closeViewer(); });
    $('#viewerPrev').addEventListener('click', ()=>{ if(viewerPhotos.length>1){ viewerIndex=(viewerIndex-1+viewerPhotos.length)%viewerPhotos.length; updateViewer(); }});
    $('#viewerNext').addEventListener('click', ()=>{ if(viewerPhotos.length>1){ viewerIndex=(viewerIndex+1)%viewerPhotos.length; updateViewer(); }});
    document.addEventListener('keydown', e=>{ if(e.key==='Escape' && !$('#photoViewer').hidden){ closeViewer(); } });

    activateTab('form');

    // ===== Self-test (light) =====
    (function(){ const t=$('#thumbs'); const prev=t.children.length; renderThumb('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR4nGMAAQAABQABe9L2WQAAAABJRU5ErkJggg=='); console.log('Selftest renderThumb:', t.children.length===prev+1); t.firstChild?.remove(); })();
  </script>
</body>
</html>
